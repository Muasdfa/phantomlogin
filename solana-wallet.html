<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Solana Memecoin Wallet</title>
    <!-- Firebase SDKs (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@1.73.0/lib/index.iife.js"></script>
    <style>
      body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
      input, button { font-size: 1rem; padding: .5rem; margin: .3rem 0; }
    </style>
  </head>
  <body>
    <h1>Solana Memecoin Wallet</h1>

    <div id="auth">
      <h2>Sign Up / Log In</h2>
      <input id="email"    type="email"    placeholder="Email" /><br/>
      <input id="password" type="password" placeholder="Password" /><br/>
      <button id="signup">Sign Up</button>
      <button id="login">Log In</button>
      <div id="auth-msg"></div>
    </div>

    <div id="app" style="display:none;">
      <p>Welcome, <span id="user-email"></span>!  <button id="logout">Log Out</button></p>

      <button id="connect-wallet">Connect Phantom Wallet</button>
      <p id="wallet-info"></p>

      <h3>Your Balance</h3>
      <p id="balance">-- SOL</p>

      <p>To deposit, simply send SOL to your Phantom address above.</p>
    </div>

    <script>
    // 1) Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyATdSh9jZBAvR6PjV7X-3VVKWZDB2Tld1I",
      authDomain: "vetra-login-39106.firebaseapp.com",
      projectId: "vetra-login-39106",
      storageBucket: "vetra-login-39106.firebasestorage.app",
      messagingSenderId: "1080730669130",
      appId: "1:1080730669130:web:fe6bf5694779f4096f16b3",
      measurementId: "G-0T7NT0E96Z"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2) Element references
    const emailInput    = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const authMsg       = document.getElementById("auth-msg");
    const authDiv       = document.getElementById("auth");
    const appDiv        = document.getElementById("app");
    const userEmailSpan = document.getElementById("user-email");
    const signupBtn     = document.getElementById("signup");
    const loginBtn      = document.getElementById("login");
    const logoutBtn     = document.getElementById("logout");
    const connectBtn    = document.getElementById("connect-wallet");
    const walletInfoP   = document.getElementById("wallet-info");
    const balanceP      = document.getElementById("balance");

    // 3) Auth handlers
    signupBtn.onclick = () => {
      auth.createUserWithEmailAndPassword(
        emailInput.value,
        passwordInput.value
      ).then(() => {
        authMsg.textContent = "Signed up! Please log in.";
      }).catch(err => {
        authMsg.textContent = err.message;
      });
    };
    loginBtn.onclick = () => {
      auth.signInWithEmailAndPassword(
        emailInput.value,
        passwordInput.value
      ).catch(err => {
        authMsg.textContent = err.message;
      });
    };

    // 4) Auth state listener
    auth.onAuthStateChanged(user => {
      if (user) {
        authDiv.style.display = "none";
        appDiv.style.display  = "block";
        userEmailSpan.textContent = user.email;
      } else {
        authDiv.style.display = "block";
        appDiv.style.display  = "none";
      }
    });

    // 5) Connect Phantom and fetch pubkey
    connectBtn.onclick = async () => {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          const pubkey = resp.publicKey.toString();
          walletInfoP.textContent = "Address: " + pubkey;
          // Save to Firestore under users/{uid}
          const uid = auth.currentUser.uid;
          await db.collection("users").doc(uid).set(
            { id: uid, pubkey },
            { merge: true }
          );
          updateBalance(pubkey);
        } catch (err) {
          console.error(err);
          alert("Wallet connection failed: " + err.message);
        }
      } else {
        alert("Phantom wallet not found. Please install Phantom.");
      }
    };

    // 6) Fetch and display SOL balance
    async function updateBalance(pubkey) {
      const connection = new solanaWeb3.Connection(
        "https://api.mainnet-beta.solana.com",
        "confirmed"
      );
      const balance = await connection.getBalance(
        new solanaWeb3.PublicKey(pubkey)
      );
      balanceP.textContent = (balance / solanaWeb3.LAMPORTS_PER_SOL)
        .toFixed(4) + " SOL";
    }

    // 7) Log out
    logoutBtn.onclick = () => auth.signOut();
    </script>
  </body>
</html>
